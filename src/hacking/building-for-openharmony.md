# Building for OpenHarmony

<div class="warning _note">
Support for OpenHarmony is currently in-progress and these instructions might change from time to time and might also be incomplete.
</div>

The building for servo is currently done in two steps and needs a Linux workstation and MacOS/Windows computer for bundling.
1. Build the shared library (libservo.so).
2. Create the App Bundle.

## Step 1
### Prerequisites
1. Go to the [OpenHarmony release notes](https://gitee.com/openharmony/docs/blob/master/zh-cn/release-notes/Readme.md) and select the version you want to compile for.
2. Scroll down to the section "Acquiring Source Code from Mirrors" and click the download link for the version of "Public SDK package for the standard system" matching your host system.
3. Extract the archive to a suitable location.
4. Switch into the SDK folder with `cd <sdk_folder>/<your_operating_system>`.
5. Create a sub-folder with the same name as the API version (e.g 12 for SDK v5.0) and switch into it.
6. Unzip the zip files of the individual components into the folder created in the previous step. Preferably use the `unzip` command on the command-line, or manually ensure that the unzipped bundles are called e.g. `native` and not `native-linux-x64-5.x.y.z`.


### Building servoshell

Before building servo you will need to set some environment variables.
[direnv](https://direnv.net) is a convenient tool that can automatically set these variables based on an `.envrc` file, but you can also use any other method to set the required environment variables.

`.envrc`:
```commandline
    export OHOS_SDK_NATIVE=/path/to/openharmony-sdk/platform/api-version/native
    export OHOS_BASE_SDK_HOME=/path/to/openharmony-sdk/platform
    export HVIGOR_PATH=/path/to/parent/directory/containing/node_modules  # Not required if `hvigorw` is in $PATH
```

If you use `direnv` and an `.envrc` file, please remember to run `direnv allow .` after modifying the `.envrc` file.
Otherwise, the environment variables will not be loaded.

The following command can then be used to compile the servoshell application for a 64-bit ARM device or emulator:

```commandline
./mach build --ohos --release --flavor=harmonyos
```

Now you should have a shared library in /path/to/servo/target/aarch64-unknown-linux-ohos/release/libservoshell.so.
You can ignore the error about hvigor tool as we will not produce the app bundle on this machine.


## Step 2
This step is the most easy with a Windows or MacOS computer for now.
### Downloading via DevEco Studio
[DevEco Studio](https://developer.huawei.com/consumer/cn/deveco-studio) is an IDE for developing applications for HarmonyOS
NEXT and OpenHarmony.
It supports Windows and MacOS.
You can manage installed OpenHarmony SDKs by clicking File->Settings and selecting "OpenHarmony SDK".
After setting a suitable installation path, you can select the components you want to install for each available API version.
DevEco Studio will automatically download and install the components for you. Alternatively go to
`File > Settings > OpenHarmony SDK`

### Finishing up
- Clone `https://github.com/jschwe/ServoDemo` and open it with DevEco Studio.
- Copy the libservoshell.so from Step 1 into `/path/to/ServoDemo/entry/libs/arm64-v8a/`
- Create the signing information the following way
  1. Open Project Structure dialog from `File > Project Structure` menu.
  2. Under the 'Signing Config' tab, enable the 'Automatically generate signature' checkbox. (This requires an active huawei developer account, you can sign in on the same dialog).
- Compile in DevEco Studio and run it on device.

**NOTE: The signature autogenerated above is intended only for development and testing. For production builds and distribution via an App Store, the relevant configuration needs to be obtained from the App Store provider.**